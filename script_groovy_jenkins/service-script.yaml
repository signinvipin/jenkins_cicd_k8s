#!/usr/bin/env groovy
def STATUS = ['SUCCESS': 'good', 'FAILURE': 'danger', 'UNSTABLE': 'danger', 'ABORTED': 'danger']

pipeline {
    agent { label '' }
    environment {
        VER = VersionNumber([versionNumberString : '${BUILD_YEAR}.${BUILD_MONTH}.${BUILD_DAY}.ARTECH${BUILDS_ALL_TIME}', projectStartDate : '2019-8-27']);
        imageName = "pipe";
        dockerRegistry = "signinvipin"
    }
    stages {

        stage('clone the git repository') {
            steps {
                script{
                    currentBuild.displayName = VER
                }
                checkout([$class: 'GitSCM', branches: [[name: '*/main']], extensions: [], userRemoteConfigs: [[credentialsId: 'git-credentials', url: 'https://github.com/signinvipin/jenkins_cicd_k8s.git']]])
            }    
        }//end clone the git repository

        stage ('Docker Build & Push') {            
            steps {
                    withCredentials([usernamePassword(
                    credentialsId: 'dockerhub-credentials', 
                    usernameVariable: 'DOCKER_USER', 
                    passwordVariable: 'DOCKER_PASS')])
                    {
                    sh """ 
                        pwd
                        ls
                        echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
                        docker build -t $dockerRegistry/$imageName:$VER  --pull .
                        docker push $dockerRegistry/$imageName:$VER
                    """
                    }        
            }
        }//end build
          
        stage('Deploying App to Kubernetes') {
            steps {
                script {
                    kubernetesDeploy(configs: "nexus.yml" , kubeconfigId: "mycluster")
                }
    
            }//end steps
        }// end push 
	     
    }//end stages

}//end pipeline